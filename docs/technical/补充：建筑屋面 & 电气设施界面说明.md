在现有技术栈文档的基础上，把**建筑屋面**和**电气设施**两个模块的「配置说明」补齐，重点是：

- 以**配置驱动**（JSON / TypeScript）的方式描述字段和界面结构；
- 让 mobile H5 和 admin Web 可以共用同一份配置；
- 方便后续扩展（加字段不用改很多页面代码）。

下面内容你可以直接放进之前的技术栈文档中作为新的章节。

------

## 六、配置驱动的表单与界面（补充：建筑屋面 & 电气设施）

### 6.1 配置思想简述

在 `packages/shared-config` 里，为每个业务模块维护一份**字段配置**，例如：

- `roofConfig.ts` – 建筑屋面模块配置
- `electricalConfig.ts` – 电气设施模块配置

前后端共用这些配置：

- Mobile H5：根据配置动态渲染 Tab / Section / 表单字段 / 上传组件；
- Web Admin：用同样的配置渲染详情、编辑界面，保证字段一致。

推荐定义一个通用配置类型：

```ts
// packages/shared-types/form.ts
export type FieldType =
  | 'text'
  | 'textarea'
  | 'number'
  | 'select'
  | 'radio'
  | 'checkbox'
  | 'chips'
  | 'image'
  | 'image-multi'
  | 'status'        // 收资状态
  | 'divider';

export interface OptionItem {
  label: string;
  value: string;
}

export interface FieldConfig {
  key: string;            // 数据字段名，如 "roofName"
  label: string;          // 中文名称
  type: FieldType;
  required?: boolean;
  placeholder?: string;
  options?: OptionItem[]; // 下拉/单选/多选可选项
  enumKey?: string;       // 对应公共枚举，例如 "ROOF_TYPE"
  multiple?: boolean;     // 多选
  maxImages?: number;     // 图片数量限制
  description?: string;   // 辅助说明
}

export interface SectionConfig {
  key: string;            // "basic", "surface" ...
  title: string;          // 分组标题
  fields: FieldConfig[];
}

export interface ModuleConfig {
  key: string;            // "roof", "electrical"
  title: string;
  sections: SectionConfig[];
}
```

然后**建筑屋面**和**电气设施**模块都按照 `ModuleConfig` 来配置。

------

## 6.2 建筑屋面模块配置（Roof Module）

建筑屋面本身是一个**多实例模块**（多个屋顶），结构如下：

- 每个 Report 下有 `roofs: Roof[]`
- 每个 Roof 使用同一份配置，但数据实例不同。

### 6.2.1 数据模型（简版）

```ts
// packages/shared-types/roof.ts
export interface Roof {
  id: string;
  reportId: string;

  // 基础信息
  roofName: string;
  roofArea: number;
  roofType: string;       // 枚举，如 "彩钢瓦" 等
  capacityMw?: number;
  overviewImage?: string;
  orientation?: string;

  // 屋顶屋面
  utilization?: string;   // 利用率：障碍物多/少/无
  obstacleTypes?: string[]; // ["parapet", "skylight"...]
  obstacleImage?: string;
  pollutionLevel?: string;
  pollutionImage?: string;

  // 内部结构
  structureType?: string;
  structureImage?: string;
  abnormalTypes?: string[];
  abnormalImage?: string;
  abnormalDescription?: string;

  // 房屋周边
  surroundingDescription?: string;
  surroundingImage?: string;
}
```

### 6.2.2 配置文件示例：`roofConfig.ts`

```ts
// packages/shared-config/roofConfig.ts
import { ModuleConfig } from '@shared-types/form';

export const roofModuleConfig: ModuleConfig = {
  key: 'roof',
  title: '建筑屋面',
  sections: [
    // 1. 基础信息
    {
      key: 'basic',
      title: '基础信息',
      fields: [
        {
          key: 'roofName',
          label: '屋顶名称',
          type: 'text',
          required: true,
          placeholder: '例如：1#厂房屋顶',
        },
        {
          key: 'roofArea',
          label: '屋顶面积（m²）',
          type: 'number',
          required: true,
          placeholder: '请输入屋顶可利用面积',
        },
        {
          key: 'roofType',
          label: '屋顶类型',
          type: 'select',
          required: true,
          enumKey: 'ROOF_TYPE', // 使用公共枚举
          placeholder: '请选择屋顶类型',
        },
        {
          key: 'capacityMw',
          label: '装机容量（MW）',
          type: 'number',
          required: true,
          placeholder: '请输入拟建光伏装机容量',
        },
        {
          key: 'overviewImage',
          label: '房屋鸟瞰图',
          type: 'image',
          description: '请上传包含屋顶轮廓的鸟瞰图，可参考示例',
        },
        {
          key: 'orientation',
          label: '朝向',
          type: 'text',
          placeholder: '可通过罗盘或地图获取（例如：南偏东15°）',
        },
      ],
    },

    // 2. 屋顶屋面
    {
      key: 'surface',
      title: '屋顶屋面',
      fields: [
        {
          key: 'utilization',
          label: '屋顶利用率',
          type: 'select',
          enumKey: 'ROOF_UTILIZATION', // 如：障碍物较多/较少/无
          placeholder: '请选择屋顶利用率',
        },
        {
          key: 'obstacleTypes',
          label: '遮挡物类型',
          type: 'chips',
          multiple: true,
          enumKey: 'ROOF_OBSTACLE_TYPE', // 女儿墙/气楼/烟囱...
        },
        {
          key: 'obstacleImage',
          label: '遮挡物照片',
          type: 'image',
          description: '拍摄屋面凸出物、管线、天窗等位置',
        },
        {
          key: 'pollutionLevel',
          label: '污染情况',
          type: 'select',
          enumKey: 'ROOF_POLLUTION_LEVEL', // 污染较重/一般/基本无
          placeholder: '请选择屋面污染情况',
        },
        {
          key: 'pollutionImage',
          label: '屋面污染照片',
          type: 'image',
          description: '拍摄屋面灰尘、锈蚀、积水等典型位置',
        },
      ],
    },

    // 3. 内部结构
    {
      key: 'structure',
      title: '内部结构',
      fields: [
        {
          key: 'structureType',
          label: '结构类型',
          type: 'select',
          enumKey: 'BUILDING_STRUCTURE_TYPE', // 钢结构/框架/排架等
          placeholder: '请选择结构类型',
        },
        {
          key: 'structureImage',
          label: '结构照片',
          type: 'image',
          description: '拍摄檩条、梁柱节点等关键受力部位',
        },
        {
          key: 'abnormalTypes',
          label: '异常情况',
          type: 'chips',
          multiple: true,
          enumKey: 'STRUCTURE_ABNORMAL_TYPE', // 裂缝/漏水/下沉/变形
        },
        {
          key: 'abnormalImage',
          label: '异常照片',
          type: 'image',
          description: '拍摄裂缝位置、渗水、明显变形等',
        },
        {
          key: 'abnormalDescription',
          label: '异常说明',
          type: 'textarea',
          placeholder: '描述异常位置、范围、严重程度等',
        },
      ],
    },

    // 4. 房屋周边
    {
      key: 'surrounding',
      title: '房屋周边',
      fields: [
        {
          key: 'surroundingDescription',
          label: '周边环境说明',
          type: 'textarea',
          placeholder: '说明房屋周边空地、绿化、道路、遮挡物等情况',
        },
        {
          key: 'surroundingImage',
          label: '周边环境照片',
          type: 'image',
          description: '拍摄屋顶周边环境，包含退距、通道等',
        },
      ],
    },
  ],
};
```

在 Mobile 端，你可以：

- 用一个 `DynamicFormSection` 组件读取 `roofModuleConfig.sections`，
- 按 section 渲染表单；
   在 Admin 端则用 AntD Form + AntD Upload/Select 结合同一份 config 渲染。

------

## 6.3 电气设施模块配置（Electrical Module）

电气设施模块包含四部分：

1. 现场照片
2. 设施照片（多设施）
3. 配电信息
4. 并网信息

其中「设施照片」本身是多实例（1#设施、2#设施…），类似屋顶。

### 6.3.1 数据模型（简版）

```ts
// packages/shared-types/electrical.ts

export interface ElectricalFacility {
  id: string;
  reportId: string;

  // 现场照片（整体）
  siteRoomImage?: string;
  siteTransformerImage?: string;
  siteSingleLineImage?: string;
  siteEnvImage?: string;

  // 多设施列表
  subFacilities?: SubFacility[];
  
  // 配电信息
  incomingVoltage?: string;      // 进线电压
  meteringVoltage?: string;      // 计量点电压
  switchStationLevel?: string;   // 无/10kV/35kV
  transformerInfoJson?: string;  // 变压器台账 JSON（台数/容量/型号）
  transformerDistImage?: string; // 变压器位置分布图

  // 并网信息
  gridMode?: string;             // 上网模式
  gridCabinetLocation?: string;  // 并网柜位置说明
  cableLayingMethods?: string[]; // 电缆敷设方式
  cablePathDescription?: string; // 电缆路径说明
  gridLevel?: string;            // 接入等级/并网等级
  gridSchemeDescription?: string;// 接入方案描述
  gridAttention?: string;        // 注意事项
}

export interface SubFacility {
  id: string;
  name: string;                  // 1#设施/2#设施...
  roomImage?: string;            // 配电室
  transformerImage?: string;     // 变压器及铭牌
  singleLineImage?: string;      // 一次系统图
  panelImage?: string;           // 配电柜
  meterImage?: string;           // 计量表
  envImage?: string;             // 周边环境
}
```

### 6.3.2 电气模块配置文件示例：`electricalConfig.ts`

```ts
// packages/shared-config/electricalConfig.ts
import { ModuleConfig } from '@shared-types/form';

export const electricalModuleConfig: ModuleConfig = {
  key: 'electrical',
  title: '电气设施',
  sections: [
    // 1. 现场照片（整体）
    {
      key: 'sitePhotos',
      title: '现场照片',
      fields: [
        {
          key: 'siteRoomImage',
          label: '配电房整体照片',
          type: 'image',
          description: '拍摄配电房外观及入口，反映整体环境',
        },
        {
          key: 'siteTransformerImage',
          label: '变压器及铭牌',
          type: 'image',
          description: '清晰拍摄变压器本体及铭牌信息',
        },
        {
          key: 'siteSingleLineImage',
          label: '一次系统图',
          type: 'image',
          description: '拍摄现有高低压一次系统图纸或柜门上系统图',
        },
        {
          key: 'siteEnvImage',
          label: '周边环境',
          type: 'image',
          description: '拍摄电气设施周围环境和安全通道',
        },
      ],
    },

    // 2. 多设施照片配置说明（通过 SubFacility 单独处理，不在此 ModuleConfig 中展开）

    // 3. 配电信息
    {
      key: 'distribution',
      title: '配电信息',
      fields: [
        {
          key: 'incomingVoltage',
          label: '进线电压',
          type: 'select',
          enumKey: 'VOLTAGE_LEVEL', // 0.4kV/10kV/35kV...
          required: true,
        },
        {
          key: 'meteringVoltage',
          label: '计量点电压',
          type: 'select',
          enumKey: 'VOLTAGE_LEVEL',
        },
        {
          key: 'switchStationLevel',
          label: '开关站',
          type: 'radio',
          options: [
            { label: '无开关站', value: 'none' },
            { label: '10kV', value: '10kV' },
            { label: '35kV', value: '35kV' },
          ],
        },
        {
          key: 'transformerInfoJson',
          label: '变压器信息',
          type: 'textarea',
          description:
            '可简要填写台数/单台容量/型号接线方式，或在 Web 端维护详细表格',
        },
        {
          key: 'transformerDistImage',
          label: '变压器位置分布图',
          type: 'image',
          description:
            '在厂区平面图上标注变压器位置后拍照上传，便于后续接入方案设计',
        },
      ],
    },

    // 4. 并网信息
    {
      key: 'grid',
      title: '并网信息',
      fields: [
        {
          key: 'gridMode',
          label: '上网模式',
          type: 'select',
          enumKey: 'GRID_MODE', // 自发自用余电上网/全额上网等
          required: true,
        },
        {
          key: 'gridCabinetLocation',
          label: '并网柜位置',
          type: 'textarea',
          placeholder: '说明拟定并网柜安装位置、空间条件等',
        },
        {
          key: 'cableLayingMethods',
          label: '新增电缆敷设方式',
          type: 'checkbox',
          options: [
            { label: '电缆沟', value: 'trench' },
            { label: '桥架', value: 'tray' },
            { label: '直埋', value: 'direct_buried' },
            { label: '顶管', value: 'pipe_jacking' },
            { label: '其他', value: 'other' },
          ],
        },
        {
          key: 'cablePathDescription',
          label: '电缆路径说明',
          type: 'textarea',
          placeholder: '描述电缆走向、途经建筑、估算路径长度等',
        },
        {
          key: 'gridLevel',
          label: '拟定接入（并网等级）',
          type: 'select',
          enumKey: 'GRID_LEVEL', // 0.4kV/10kV/35kV 等
        },
        {
          key: 'gridSchemeDescription',
          label: '接入方案描述',
          type: 'textarea',
          placeholder: '描述接入点、接线方式、需新增设备等',
        },
        {
          key: 'gridAttention',
          label: '注意事项',
          type: 'textarea',
          placeholder:
            '补充记录环境影响、施工成本、安全风险等注意事项',
        },
      ],
    },
  ],
};
```

### 6.3.3 多设施 SubFacility 的界面配置说明

SubFacility 部分与整体 ModuleConfig 略有区别，因为它是**子列表**，通常你会：

- Mobile H5：顶部“1#设施 / +新增”，每个设施内部有一套固定图片项；
- Web Admin：在电气模块详情中，以折叠面板或 Tab 列表展示每个设施。

可以这样在 `shared-config` 中定义子设施字段：

```ts
// packages/shared-config/electricalSubFacilityConfig.ts
import { SectionConfig } from '@shared-types/form';

export const subFacilitySection: SectionConfig = {
  key: 'subFacilityPhotos',
  title: '设施照片',
  fields: [
    {
      key: 'name',
      label: '设施名称',
      type: 'text',
      required: true,
      placeholder: '例如：1#配电室',
    },
    {
      key: 'roomImage',
      label: '配电室',
      type: 'image',
    },
    {
      key: 'transformerImage',
      label: '变压器及铭牌',
      type: 'image',
    },
    {
      key: 'singleLineImage',
      label: '一次系统图',
      type: 'image',
    },
    {
      key: 'panelImage',
      label: '配电柜',
      type: 'image',
    },
    {
      key: 'meterImage',
      label: '计量表',
      type: 'image',
    },
    {
      key: 'envImage',
      label: '周边环境',
      type: 'image',
    },
  ],
};
```

Mobile H5 侧可以有一个通用组件：

- `SubFacilityList`：
  - 传入 `subFacilities: SubFacility[]` 与 `subFacilitySection` 配置；
  - 渲染顶部标签（1#设施、2#设施）；
  - 中间用 `DynamicFormSection` 按 `subFacilitySection` 渲染字段。

Admin 端可以用 AntD 的 Tabs / Collapse 实现同样的体验。

------

## 6.4 这两块配置如何在技术栈中被使用

1. **shared-config 中定义**
   - `roofModuleConfig`、`electricalModuleConfig`、`subFacilitySection` 等；
2. **Mobile H5**
   - 动态表单组件读取这些配置，渲染 UI（输入框、选择器、Chip、图片上传等）；
3. **Admin Web**
   - 使用相同配置，渲染详情/编辑界面，保证字段一一对应；
4. **Workers / D1**
   - `shared-types` 定义的数据模型（Roof、ElectricalFacility、SubFacility）用于数据库建表和 API 类型；
   - 前端提交/查询的 JSON 结构与这些类型保持一致。

这样，**建筑屋面**和**电气设施**的界面配置就和之前的厂区概况、收资清单一样，纳入到统一的配置驱动体系中，方便维护和扩展。

