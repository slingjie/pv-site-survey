踏勘系统的**技术栈文档**，并在其中补充了「Cloudflare Pages + Workers + React」的整体项目结构草图，适合作为内部评审和落地实现的基础版本。

------

# 一、项目整体目标与约束

- **终端形态**
  - 手机端：H5（浏览器/App 内嵌 WebView），用于现场踏勘录入、查看。
  - Web 端：桌面管理后台，用于多项目查询、审核、导出报告。
- **部署平台**
  - 前端：Cloudflare Pages
  - 后端 API：Cloudflare Workers
  - 对象存储 / 轻量数据库：使用 Cloudflare R2 / D1 / KV（或接其他云服务）
- **设计目标**
  - 首版快速上线（MVP），优先保证流程通畅与数据可靠；
  - 清晰的前后端分层，可迭代扩展（权限、报表、更多表单项）。

------

# 二、技术栈选型

## 2.1 前端（Mobile H5）

- **框架**：React 18+
- **路由**：React Router 6/7（BrowserRouter / HashRouter 视 Cloudflare 配置而定）
- **构建工具**：Vite（性能好、与 Cloudflare Pages 兼容度高）
- **UI 组件库（移动端）**：
  - 可选：Ant Design Mobile 或其他成熟的 React 移动端组件库
- **状态管理**：
  - 轻量方案：React Query + 组件内局部 state（足够应对当前业务）
  - 如未来变复杂可引入 Zustand / Redux Toolkit
- **表单管理**：
  - react-hook-form 或 Formik + 自研业务组件（方便处理复杂必填校验）
- **地图/定位**：
  - 原生 `navigator.geolocation` + 高德/百度 Web JS SDK（视实际需求）

> 角色定位：
>  负责「踏勘报告编辑/查看」，所有你之前定义的厂区概况、建筑屋面、电气设施、收资清单等表单全部在此实现。

------

## 2.2 前端（Web 管理端）

- **框架**：React 18+
- **路由**：React Router
- **构建工具**：Vite
- **UI 组件库（桌面）**：Ant Design 5.x
- **表格与筛选**：AntD Table + Form
- **图表（如后续有统计需求）**：ECharts / AntV G2 / Recharts（任选其一）

> 角色定位：
>  项目管理、记录列表、详情查看、导出 PDF/Word 报告（从 Workers API 获取数据）。

------

## 2.3 后端（API 层 – Cloudflare Workers）

- **运行时**：Cloudflare Workers（基于 V8 的无服务器环境）
- **语言 / 框架**：
  - TypeScript
  - 可选：Hono / itty-router / 自定义 Router 简化路由注册
- **数据存储**：
  - 结构化数据：Cloudflare D1（SQLite 兼容，适合轻量业务）
  - 键值型/缓存：Cloudflare KV（存放会话、简单配置）
  - 文件 / 图片：Cloudflare R2（对象存储）
- **ORM / 查询**：
  - D1 可搭配 Drizzle ORM / Kysely，或手写 SQL（看团队熟悉程度）
- **认证（后续可扩展）**：
  - 内部系统可先用简单的 Token / API Key 机制；
  - 后续可接入 OAuth2 / 企业内部 SSO。

> 角色定位：
>  统一对外提供 REST API，供 Mobile H5 和 Web 管理端调用。

------

## 2.4 项目管理与协作工具

- **代码托管**：GitHub / GitLab
- **CI/CD**：
  - 使用 Cloudflare Pages / Workers 与 Git 仓库直接集成，Push 即触发构建与部署。
- **设计协作**：Figma（你已有完整 IA & UI 规范）
- **需求与任务跟踪**：Jira / 飞书多维表格 / Notion（视团队工具栈）

------

# 三、整体项目结构草图（Cloudflare Pages + Workers + React）

## 3.1 逻辑架构示意图

用文字画一个整体结构（从浏览器到 Cloudflare）：

```text
[手机浏览器] ── H5 应用（React SPA）
                        │
                        │ HTTPS
                        ▼
             Cloudflare Pages（mobile-app）

[PC 浏览器] ── Web 管理端（React + AntD SPA）
                        │
                        │ HTTPS
                        ▼
             Cloudflare Pages（admin-app）

两端前端应用
       │
       │ 调用 API（REST / JSON）
       ▼
Cloudflare Workers（API 网关 / 业务逻辑）
       │
       ├── D1（结构化数据：报告、屋顶、厂区、电气、收资状态）
       ├── KV（缓存、配置、会话）
       └── R2（图片、附件、导出的 PDF 报告等）
```

可根据域名规划：

- mobile H5：`https://m.yourdomain.com` → Cloudflare Pages 项目：`mobile-app`
- web 管理端：`https://admin.yourdomain.com` → Pages 项目：`admin-app`
- API：`https://api.yourdomain.com` → Workers 服务：`takan-api`

------

## 3.2 代码仓库与目录结构草图

建议使用一个 monorepo（便于共享类型、字段配置等）：

```text
repo-root
├── apps
│   ├── mobile/            # 手机端 H5（React + React Router + 移动 UI）
│   │   ├── src
│   │   │   ├── main.tsx
│   │   │   ├── app.tsx
│   │   │   ├── routes/    # /reports, /reports/:id/overview ...
│   │   │   ├── pages/     # 各业务页面
│   │   │   ├── components/# 通用表单、Tab、Upload组件等
│   │   │   └── api/       # 调用 Workers API 的封装
│   │   └── vite.config.ts
│   │
│   └── admin/             # Web 管理端（React + Ant Design）
│       ├── src
│       │   ├── main.tsx
│       │   ├── app.tsx
│       │   ├── routes/    # /dashboard, /reports, /reports/:id ...
│       │   ├── pages/     # 列表页、详情页、报表导出页
│       │   ├── components/# 表格、过滤栏、详情面板
│       │   └── api/       # 同样调用 Workers API
│       └── vite.config.ts
│
├── services
│   └── worker-api/        # Cloudflare Workers (takan-api)
│       ├── src
│       │   ├── index.ts   # worker 入口，路由注册
│       │   ├── routes/    # /reports, /roofs, /plants 等 API
│       │   ├── db/        # D1 表结构定义、SQL/ORM
│       │   ├── storage/   # R2 读写封装（图片/文件）
│       │   └── utils/     # 通用工具、鉴权等
│       └── wrangler.toml  # Cloudflare Worker 配置（绑定 D1/KV/R2）
│
├── packages
│   ├── shared-types/      # 全局 TS 类型定义（Report, Roof, Electrical, DocStatus）
│   ├── shared-config/     # 字段配置（枚举：屋顶类型、风险类型、收资项清单）
│   └── shared-ui/         # 可能的通用 UI（如字段渲染器，可选）
│
├── package.json
├── pnpm-workspace.yaml / turbo.json（如使用 monorepo 工具）
└── README.md
```

要点：

- Mobile 和 Admin 各自是独立 React/Vite 项目，方便分别构建成两套 Pages。
- Worker 单独一个子目录，用 Wrangler 构建部署到 Cloudflare Workers。
- `packages/shared-*` 用于前后端共享：
  - 数据类型（屋顶/厂区/电气/收资）
  - 枚举和选项（屋顶类型列表、风险标签、用电时段下拉项）
  - 这样修改一处即可同步更新两端。

------

## 3.3 Cloudflare 配置草图

### 3.3.1 Pages（前端）

**mobile-app**

- 绑定仓库：`repo-root`
- 构建命令：`cd apps/mobile && pnpm install && pnpm build`
- 输出目录：`apps/mobile/dist`
- 绑定域名：`m.yourdomain.com`

**admin-app**

- 绑定仓库：`repo-root`
- 构建命令：`cd apps/admin && pnpm install && pnpm build`
- 输出目录：`apps/admin/dist`
- 绑定域名：`admin.yourdomain.com`

两者都作为 SPA 部署（Vite React 模板默认支持），Cloudflare Pages 默认处理 404 回退，兼容 React Router。

------

### 3.3.2 Workers（API）

在 `services/worker-api/wrangler.toml` 中配置绑定：

```toml
name = "takan-api"
main = "src/index.ts"
compatibility_date = "2025-01-01"

[[d1_databases]]
binding = "DB"
database_name = "takan-db"

[[kv_namespaces]]
binding = "CONFIG"
id = "xxxxxx"

[[r2_buckets]]
binding = "FILES"
bucket_name = "takan-files"

[vars]
CORS_ORIGIN_MOBILE = "https://m.yourdomain.com"
CORS_ORIGIN_ADMIN  = "https://admin.yourdomain.com"
```

然后在 Cloudflare Dashboard 中将：

- `https://api.yourdomain.com/*` → 路由到 `takan-api` Worker 服务。

前端 H5 和 Web 管理端统一调用 `https://api.yourdomain.com` 下的 REST 接口。

------

# 四、典型开发流程（示意）

1. 产品 / 你：在 Figma 中完成页面和组件设计，基于之前的 IA 和 UI 规范。
2. 前端：
   - 在 `apps/mobile` 中实现踏勘 H5；
   - 在 `apps/admin` 中实现管理后台；
   - API 调用全部指向 `api.yourdomain.com`。
3. 后端：
   - 在 `services/worker-api` 实现对应 REST API、D1 表结构、R2 上传接口；
   - 定义统一的数据模型并写到 `packages/shared-types`。
4. 推送代码到 Git 仓库：
   - Cloudflare Pages 自动构建 `mobile-app` 和 `admin-app`；
   - wrangler 部署命令（或 GitHub Actions）部署 Workers。

------

# 五、小结

- **技术栈角度**：
  - React + React Router（H5）
  - React + Ant Design（Web 管理端）
  - Cloudflare Pages（静态前端）
  - Cloudflare Workers + D1 + R2 + KV（API 和存储）
     非常契合你当前业务和 Cloudflare 平台能力。
- **架构角度**：
  - 前端划分为 mobile / admin 两个 SPA；
  - 后端统一由一个 Worker API 提供服务；
  - 通过 shared packages 复用数据模型与字段配置，降低维护成本。