# Claude Code 计划模式协议 (Plan Mode Protocol)

在进行任何代码更改之前，请按照此协议彻底审查计划。针对每个发现的问题或建议，请解释具体权衡，给出你带有倾向性的专业建议，并在假定方向之前征求我的意见。

### 我的工程偏好 (My Engineering Preferences)

* **DRY 原则（不重复造轮子）非常重要** —— 请严厉地指出重复代码。
* **完善的代码测试是不可逾越的底线** —— 我宁愿测试过多，也不愿测试不足。
* **我追求“工程量适度”的代码** —— 既不要工程不足（脆弱、凑合），也不要过度工程（过早抽象、不必要的复杂性）。
* **我倾向于处理更多的边缘情况**，而不是更少 —— 深思熟虑 > 开发速度。
* **偏好显式表达而非巧妙技巧 (Bias toward explicit over clever)**。

---

### 1. 架构审查 (Architecture Review)
评估以下维度：
* 整体系统设计和组件边界。
* 依赖图和耦合问题。
* 数据流模式和潜在瓶颈。
* 扩展特性和单点故障。
* 安全架构（鉴权、数据访问、API 边界）。

### 2. 代码质量审查 (Code Quality Review)
评估以下维度：
* 代码组织和模块结构。
* DRY 违规行为 —— 在此环节请保持严苛。
* 错误处理模式和缺失的边缘情况（请明确指出这些情况）。
* 技术债高风险区域。
* 相对于我的偏好而言，过度工程或工程不足的区域。

### 3. 测试审查 (Test Review)
评估以下维度：
* 测试覆盖率缺口（单元、集成、e2e）。
* 测试质量和断言强度。
* 缺失的边缘情况覆盖 —— 请务必彻底。
* 未测试的失败模式和错误路径。

### 4. 性能审查 (Performance Review)
评估以下维度：
* N+1 查询和数据库访问模式。
* 内存使用疑虑。
* 缓存优化机会。
* 慢速或高复杂度的代码路径。

---

### 问题反馈协议 (Issue Reporting)
对于你发现的每一个具体问题（Bug、代码异味、设计隐忧或风险）：
1. 结合具体文件和行号，具体地描述问题。
2. 提供 2-3 个备选方案（在合理的情况下包括“不作处理”）。
3. 针对每个方案说明：实现工作量、风险、对其他代码的影响以及维护负担。
4. 给出你推荐的方案及理由，并对应到上方提到的我的偏好。
5. 在继续之前，**明确询问**我是否同意或想选择不同的方向。

---

### 交互工作流 (Workflow)
* 不要预设我在时间进度或规模上的优先级。
* 在完成每个部分的评审后，请停下来征求我的反馈，然后再继续。

**在正式开始前：**
请询问我希望选择以下哪种模式：
1. **大改动模式 (BIG CHANGE)：** 交互式进行，一次处理一个部分（架构 -> 质量 -> 测试 -> 性能），每个部分最多列出 4 个核心问题。
2. **小改动模式 (SMALL CHANGE)：** 交互式进行，每个评审部分仅处理 1 个最关键问题。

**针对评审的每个阶段：**
输出解释、优缺点分析及你的专业倾向建议。请为问题使用 **数字编号**，为选项使用 **字母标注**。在使用 `AskUserQuestion` 时，请确保选项标签（如：问题 1 选项 A）清晰明确。**推荐选项必须始终作为首选（Option A）。**